name: Build and Test

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  build-frontend:
    name: Build Frontend Projects
    runs-on: ubuntu-latest

    strategy:
      matrix:
        project: ['landing', 'hyperfy']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          projects/frontend/package-lock.json
          projects/hypery-hyperland/frontend/package-lock.json

    - name: Install dependencies (Landing)
      if: matrix.project == 'landing'
      run: cd projects/frontend && npm ci

    - name: Install dependencies (Hyperfy)
      if: matrix.project == 'hyperfy'
      run: cd projects/hypery-hyperland/frontend && npm ci

    - name: Build (Landing)
      if: matrix.project == 'landing'
      run: cd projects/frontend && npm run build

    - name: Build (Hyperfy)
      if: matrix.project == 'hyperfy'
      run: cd projects/hypery-hyperland/frontend && npm run build

    - name: Lint (Landing)
      if: matrix.project == 'landing'
      run: cd projects/frontend && npm run lint || true

    - name: Lint (Hyperfy)
      if: matrix.project == 'hyperfy'
      run: cd projects/hypery-hyperland/frontend && npm run lint || true

  test-contracts:
    name: Test Smart Contracts
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1

    - name: Build contracts
      run: cd contracts && forge build

    - name: Run tests
      run: cd contracts && forge test -vv

    - name: Generate gas report
      run: cd contracts && forge test --gas-report

  build-status:
    name: Build Status
    runs-on: ubuntu-latest
    needs: [build-frontend, test-contracts]
    if: always()

    steps:
    - name: Check build status
      run: |
        if [ "${{ needs.build-frontend.result }}" != "success" ] || [ "${{ needs.test-contracts.result }}" != "success" ]; then
          echo "Build or tests failed"
          exit 1
        fi
        echo "All builds and tests passed!"
